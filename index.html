<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  零度燕窝
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="零度燕窝" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site:blog.yanzl.net ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="self" href="index.html">Home</a></li>
        
        <li id=""><a target="_self" href="archives.html">Archives</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="http://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; 零度燕窝</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
       
       <li><a href="index.html">HOME</a></li>
    <li><a href="archives.html">Archives</a></li>
    <li><a href="about.html">ABOUT</a></li>

    <li><label>Categories</label></li>

        
            <li><a href="%E6%95%B0%E6%8D%AE%E5%BA%93.html">数据库</a></li>
        
            <li><a href="Python.html">Python</a></li>
        
            <li><a href="%E9%9A%8F%E6%83%B3.html">随想</a></li>
        
            <li><a href="%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84&%E7%AE%97%E6%B3%95.html">数据结构&算法</a></li>
        
            <li><a href="Fluent%20Python.html">Fluent Python</a></li>
        
            <li><a href="%E8%AF%BB%E4%B9%A6%E9%9A%8F%E7%AC%94.html">读书随笔</a></li>
        
            <li><a href="%E6%9B%BE%E7%BB%8F%E6%9D%A5%E8%BF%87.html">曾经来过</a></li>
        
            <li><a href="PHP.html">PHP</a></li>
        
            <li><a href="Ubuntu.html">Ubuntu</a></li>
         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
	$(function(){
		$('#menu_item_index').addClass('is_active');
	});
</script>
<div class="row">
	<div class="large-8 medium-8 columns">
		<div class="markdown-body home-categories">
		
			<div class="article">
                <a class="clearlink" href="15463298937289.html">
                
                  <h1>人生第一次30公里复盘总结</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>从来没想过自己可以跑 30 公里，这次也只是机缘巧合，原定 24 公里，结果绕了远路，在起点与终点没有改变的前提下，跑完了人生第一个 30 公里。对我来讲，这是一件非常有意义的事情，为了让它变得更有意义，决定写一篇复盘总结，记录整个过程中在放弃边缘的挣扎与所思所想。</p>

<h2 id="toc_0">留出充足的准备时间</h2>

<p>我不是一个喜欢踩点的人，上班也好，平时有什么事情也好，都会喜欢提前到达，一来可以处理中间路途的突发状况，二来去的早了，可以提前做一些准备。然而今天很遗憾，踩点到了，并且因为换衣服还耽误了一些时间，导致运动前没有充分地拉伸，在跑了 7、8 公里后脚腕会有一些疼。回顾一下，主要是因为没有提前做好准备工作，早上起来后发现温度太低，临时找添加的衣服；另外就是早上时间预留不充足，乘车时间只预留了导航上显示的时间，并没有考虑找出入口以及其他的一些机动时间在内。这可以算是一次失误，也是以后类似事件的改进点。</p>

<h2 id="toc_1">需要相互鼓励</h2>

<p>在跑了 13、14 公里之后，就已经超出平时锻炼的距离了，虽然知道自己距离终点还有 10 公里的样子，但已经出现了跟不上节奏的苗头了。很感谢在旁边一直跟着我跑的那个小哥哥，如果不是两个人一起跑，我真的有可能会停下来走一段距离。这是在整个过程中，第一次有想要放弃的念头，但在这样一个需要耐力的运动中，最忌讳的就是向身边同伴输出负能量，那样不仅自己会放弃，还会带着咬牙坚持的同伴产生放弃的念头。在这个过程中，我讲了一些以前跑步过程中比较难望的经历，询问同伴的锻炼经历，并讲一些激励人心的话，这些话，不仅是讲给同伴听，更重要的是讲给自己，不断鼓励自己，不能放弃，一定要坚持。就这样，两个人 砥砺前行。</p>

<h2 id="toc_2">对异常的敏感性</h2>

<p>工作的过程中，会在可能出现异常的地方加以捕获，完成报错或其他处理的操作，以保证系统的正常运行。今天跑步的过程中，我也遇到了一个异常：一直跑在我们前面的领队，忽然在某个地点，看到他们往回跑，因为是两条线路，所以他们并没有看到我们。当时我的第一反映是跑回去接跑在我们后面的小伙伴了，因为终点方向确实没问题，就没有多想继续往前跑。结果跑出去了大概有 1、2 公里的样子，被一个电话叫回去，我们要横渡黄浦江，去另一侧跑。原来领队他们跑得太快，特意多跑了一段距离，而我，因为没有实现研究好路线，对自己看到的异常有没有那么敏感，还在那里想当然，就很当然地多跑了一段距离。</p>

<h2 id="toc_3">重拾崩溃的心态</h2>

<p>30 公里，在没有充分锻炼的前提下，真的不是随随便便就能跑下来的，在这个过程中，一定会有许多次挣扎，前面讲到的 13、14 公里的那个阶段，是很正常的一个阶段，一般挺过去就没什么事情。而心态的崩溃，往往伴随着超出了个人的预期，发生一些突发状况的时候。在今天，心态的崩溃比较强烈的有三次，一次是被告知跑错了路，需要折返回去渡江的时候；一次是被告知今天大概会跑 30 公里的时候；一次是在我认为还有 1 公里就要结束了，被告知距离终点还有 3 公里的时候。</p>

<p>每一次都是信心满满，希望满满，然后忽然被人浇了一桶凉水，好像在说：醒醒吧你，哪有这么容易！内心在挣扎，一次又一次，脑海中堕落的声音一直在呼唤着我，我是多想停下来走着啊！有一次，心理真的是承受不住，直接走了起来，但走了一小段距离后，又觉得拖累了在旁边一直陪我跑的小哥哥，拖累了整个团队的进度，况且自己来都来了，为什么不能有始有终，好好完成这样一次试炼？我一定不能放弃，就算是一小步一小步地挪，也要用跑的姿势挪到终点（事实真的是这样，QAQ），我绝不会是走过去的！！信念，可以将崩溃的心态一片一片拼凑起来，让人重新调整目标，燃起希望，继续前进。</p>

<p>当然，在这个过程中，除了信念，还有一点不得不提，那就是目标。在心态崩溃之后，目标往往也会跟着崩塌。有这么一段距离，我是不知道自己应该跑向什么地点的，终点在哪里，我距离终点到底还有多远，完全不知道，就真的是漫无目的的跑。在完全自暴自弃之前，我查了地图，重新明确了目标，虽然那个时候显示还有6 公里，走过去时间要 1 小时，但真的完全没有畏惧。因为我知道，终点就在那里，它不会变，只要调整心态，坚持信念，总能到达。</p>

<h2 id="toc_4">与大佬的交流</h2>

<p>很多事情，一味地闷头苦干，有可能可以达到最终目标，但其中也会走很多弯路。多和前辈交流，可以在关键处被指导一二，了解自己之前做的有什么不足，有什么可以改善之处，也是可以少走许多弯路的。</p>

<p>比如这次在跟前辈们的交流中，我得知如果想要轻松跑半马，单纯训练跑步是不行的，平时需要练力量，一周 2 到 3 次的跑步训练，剩下的几天可以练力量。另外，我在跑远程的时候，后面会出现抽筋的情况，今天抽筋到左右腿换着抽，拉伸稍一用力就有种拉过劲的感觉，这种情况也与力量不足有关系。之前在跑步的过程中，我会倾向喝热水，其他饮料一般不会喝，今天有学到一个知识点，即能量饮料中会含一些电解质等，这是在运动过程中需要补充的，并且后期我还喝了一瓶能量饮料，结合实践，发现能量饮料虽然比较凉，但真心要比水管用！！</p>

<p>可见，很多时候是需要虚心向前辈请教的，采纳别人的建议，加以实践验证，要比自己苦思冥想得到的结论更快，也更有效果。工作中也一样，如果有更好的轮子可用，就不必执着于费时费力得造不必要的轮子了。</p>

<h2 id="toc_5">我们是一个团队</h2>

<p>整个过程，给我最大的感触就是团队力量的强大之处，每每我跑到队伍的最后面，看不到前方的伙伴，想要放弃的时候，总能够看到领队折返回来带我跑。一个人，想要放弃很容易，但如果是一个团队，又有什么资格在别人都没有放弃自己的时候，自暴自弃？在团队小伙伴带着我继续努力的时候，我能给到的，就是坚持下去，展现当时最好的状态。反过来，如果我个人的能力很强，在个人前进的道路上，也要记得拉身边的小伙伴一把，只有与优秀的人一起，才会有危机感，自己才能变得更加优秀。</p>

<p>一个人可以跑的很快，一群人可以跑的很远。这句话，用在今天，再恰当不过，这个团队，没有拉下任何一个人，我们是一个团队，我们有始有终。</p>

<p>我很庆幸，参加了这样一次活动，也很庆幸自己在团队小伙伴的鼓励下坚持下来，让这次活动变得有意义，让我懂得，每一件事情，不是随随便便去做的，是带有目标的。</p>

<p>洋洋洒洒写了这么多，只是想把这次的经历记住，把中间的曲折、感受记住，不至于多年之后，只留下当时很艰难的印象。最后，贴上路线图以作纪念（最后 2 公里因为跑太慢，咕咚自动停了，真是忧伤~~~）。</p>

<p><img src="http://cdn.blog.yanzl.net/2019-01-01-WechatIMG117.jpeg" alt=""/></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2019/1/1</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='%E9%9A%8F%E6%83%B3.html'>随想</a></span>
          				   
                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15421053722232.html">
                
                  <h1>Flask 流式相应实现文件下载及常见问题总结</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<h2 id="toc_0">前言</h2>

<p>实现文件下载的时候，为了能够更快地响应，可以采用流式响应的方式，服务端可以边执行边将结果返回给客户端，一方面客户端可以更快进入数据接收阶段，另一方面也有效避免了服务端处理时间过长导致连接中断的情况。本文记录了 flask 采用流式响应的方式实现文件下载，以及在下载的过程中可能遇到的问题。</p>

<h2 id="toc_1">流式响应实现文件下载</h2>

<h3 id="toc_2">如何做</h3>

<p>在处理函数中写一个内联函数，通过这个内联函数生成数据，并把这个函数传递给一个响应对象。如下所示：</p>

<pre><code class="language-python">from flask import Response
def download(self):
    file_name = &#39;test.csv&#39;
    def statistic():
        sql = &#39;select * from user&#39;
        results = db.session.execute(sql)
        fieldnames = [&#39;姓名&#39;, &#39;年龄&#39;, &#39;性别&#39;, &#39;邮箱&#39;, &#39;备注&#39;]
        yield (&#39;,&#39;.join(fieldnames) + &#39;\n&#39;)
            
        for result in results:
            yield (&#39;,&#39;.join(result) + &#39;\n&#39;)
    return Response(statistic(), mimetype=&#39;text/csv&#39;,headers={&quot;Content-Disposition&quot;: &quot;attachment; filename={0};&quot;.format(file_name)})
</code></pre>

<p>以上写法只是最基础的处理，如果放在生产环境中，在生成流内容的时候，请求环境已经在函数执行时消失了，因此会遇到如下所示的错误：</p>

<pre><code>RuntimeError: application not registered on db instance and no application bound to current context
</code></pre>

<p>这种情况下，可以考虑在代码中添加 <code>with app.app_context():</code> 语句，不过这样看起来似乎有些笨拙，如果使用的 Flask 版本在 0.9 以上，可以直接使用 flask 提供的 <code>stream_with_context</code> 方法，具体使用方式如下所示：</p>

<pre><code class="language-python">from flask import stream_with_context, Response
def download(self):
    def statistic():
        pass
    return Response(stream_with_context(statistic()), mimetype=&#39;text/csv&#39;,headers={&quot;Content-Disposition&quot;: &quot;attachment; filename={0};&quot;.format(file_name)})
</code></pre>

<h3 id="toc_3">为什么要这么写</h3>

<h4 id="toc_4">WSGI 标准要求 WSGI Application 返回迭代器</h4>

<p>Flask 作为一个 Web 框架，如果要与 Web 服务器更好的组合，就要遵循 WSGI（Web Server Gateway Interface）接口规范。WSGI 标准本身就要求 WSGI Application 返回的是迭代器：</p>

<p>The application object is simply a callable object that accepts two arguments. The term &quot;object&quot; should not be misconstrued as requiring an actual object instance: a function, method, class, or instance with a call method are all acceptable for use as an application object. Application objects must be able to be invoked more than once, as virtually all servers/gateways (other than CGI) will make such repeated requests.</p>

<h4 id="toc_5">Flask 视图函数不能是生成器函数</h4>

<p>如果在 Flask 视图函数中使用 <code>yield</code>，会触发一个 <code>TypeError</code> 的异常，提示我们 <code>&#39;generator&#39; object is not callable</code>，即 Flask 要求视图函数返回的结果是可调用的。这要怎么办呢？<br/>
这个问题在网上是可以找到一些解决方法的，如下所示：</p>

<pre><code class="language-python">from flask import Response

   @app.route(&#39;/foo&#39;)
   def foo():
       def generate():
           yield &#39;first part&#39;
           yield &#39;second part&#39;
       return Response(generate())
</code></pre>

<h2 id="toc_6">常见问题</h2>

<h3 id="toc_7">下载带有中文文件名的文件</h3>

<p>有时候下载的文件名一定要是中文名，此时上述的方式是不能够满足需求的，查看服务端运行日志可以看到如下所示的报错信息：</p>

<pre><code>Traceback (most recent call last):
  File &quot;/home/deploy/weini_py3/lib/python3.4/site-packages/gunicorn/workers/gthread.py&quot;, line 274, in handle
    keepalive = self.handle_request(req, conn)
  File &quot;/home/deploy/weini_py3/lib/python3.4/site-packages/gunicorn/workers/gthread.py&quot;, line 329, in handle_request
    resp.write(item)
  File &quot;/home/deploy/weini_py3/lib/python3.4/site-packages/gunicorn/http/wsgi.py&quot;, line 327, in write
    self.send_headers()
  File &quot;/home/deploy/weini_py3/lib/python3.4/site-packages/gunicorn/http/wsgi.py&quot;, line 323, in send_headers
    util.write(self.sock, util.to_bytestring(header_str, &quot;ascii&quot;))
  File &quot;/home/deploy/weini_py3/lib/python3.4/site-packages/gunicorn/util.py&quot;, line 511, in to_bytestring
    return value.encode(encoding)
UnicodeEncodeError: &#39;ascii&#39; codec can&#39;t encode characters in position 140-143: ordinal not in range(128)
</code></pre>

<h4 id="toc_8">为什么会报错</h4>

<p>在返回数据给客户端的时候，在 Header 中添加了一些内容，包括 <code>&quot;Content-Disposition&quot;: &quot;attachment;</code> 实现强制文件下载，<code>filename=test.csv;</code> 指定下载的文件的文件名，而 header 中的文本数据必须是 ASCII 编码的， TEXT 中若要使用其他字符集，必须按照规则将字符串编码为 ASCII 码。</p>

<h4 id="toc_9">怎么办</h4>

<p>解决这个问题可以分成两个步骤。</p>

<h5 id="toc_10">编码文件名</h5>

<p>既然文件名是不可识别的，可以通过一定的方法将文件名编码成可识别字符串。根据报错原因，可以联想到 URL 也只是允许一部分 ASCII 字符（数字字母和部分符号，看起来要比 header 中文本的要求更严格），如果含有汉字这种不合 URL 标准的，为了能够正常做请求，浏览器会进行 URL 编码， 把需要编码的字符转化为 <code>%xx</code> 的形式。在这里，同样也可以将文件名进行 URL 编码。<br/>
python3 中的 <code>urllib.parse</code> 模块中提供了一个方法 <code>quote</code>,对该方法的官方解释如下所示：</p>

<p>Replace special characters in string using the %xx escape. Letters, digits, and the characters &#39;_.-&#39; are never quoted. By default, this function is intended for quoting the path section of URL. The optional safe parameter specifies additional ASCII characters that should not be quoted — its default value is &#39;/&#39;.</p>

<p>由此，就可以完成对文件名的编码，示例代码如下：</p>

<pre><code class="language-python">from urllib.parse import quote
file_name = &#39;测试.csv&#39;
file_name = quote(file_name)
</code></pre>

<h5 id="toc_11">确保浏览器正确解码</h5>

<p>HTTP 标准中，规定了浏览器至少应该支持 ASCII 和 UTF-8 两种编码处理方式，在数据返回给客户端的时候，需要告知浏览器文件名是什么编码方式，以确保浏览器能够正常完成解码。</p>

<p>由此，在 header 中给出具体设置即可。示例如下所示：</p>

<pre><code class="language-python">return Response(statistic(), mimetype=&#39;text/csv&#39;,headers={&quot;Content-Disposition&quot;: &quot;attachment; filename={0};filename*=utf-8&#39;&#39;{0}&quot;.format(file_name)})
</code></pre>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2018/11/13</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='Python.html'>Python</a></span>
          				   
                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15406290433586.html">
                
                  <h1>扎心！有人偷走了我的磁盘空间？！</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>2天前，接到系统报警，用来存储数据库数据的磁盘空间剩余不足10%，于是经过一番删表操作，成功释放了 40G 的空间，关上电脑，安心睡觉。难得今天周六可以在家好好休息，买了老母鸡准备煲个鸡汤犒劳一下自己，此时收到 leader 发来的微信：不是说磁盘空间空出了 40G 吗？现在磁盘都快爆了！！<br/>
最怕灯火阑珊时，手机响，心里慌。罢了，鸡汤之后再煲吧~打开电脑，连接线上环境，又是一通删表操作（此处还有其他操作，请不要盲目删表），执行 <code>df -h</code> 命令，奇怪的事情发生了，刚刚明明删除了大概 10G 左右的数据文件，为啥磁盘占用量只减少了 2G 左右，玩呢吧。。。。。。</p>

<h2 id="toc_0">那么问题来了</h2>

<p>文件已经删除了，到底哪里出了问题，竟然把我的磁盘空间都吃满了呢？<br/>
使用 <code>df -h</code> 命令查看对应路径下的空间占用情况，得到如图1-1所示的结果：<br/>
<center><br/>
<img src="media/15406290433586/15406328121647.jpg" alt=""/><br/>
图1-1<br/>
</center></p>

<p>这个结果看起来，磁盘分分钟就要爆了呀！！既然如此，那再看看到底是那个文件夹中的文件最占空间吧。执行 <code>du --max-depth=1 -h</code>命令，得到如图1-2所示的结果：<br/>
<center><br/>
<img src="media/15406290433586/15406330683651.jpg" alt=""/><br/>
图1-2<br/>
</center><br/>
那么问题来了，这个结果看起来，该路径下的磁盘占用量只有 109G，相比于上面查询的 152G，那 43G 去哪里了呢？为什么 <code>df -h</code> 命令查出来的结果和 <code>du -h</code>命令查出来的结果不一样呢？</p>

<h2 id="toc_1">du命令和df命令区别</h2>

<h3 id="toc_2">du命令工作原理</h3>

<p>du，disk usage,是通过搜索文件来计算每个文件的大小然后累加，du能看到的文件只是一些当前存在的，没有被删除的。他计算的大小就是当前他认为存在的所有文件大小的累加和。它的数据是基于文件获取的，所以有很大的灵活性，不一定非要针对一个分区，可以跨越多个分区操作。如果针对的目录中文件很多，du速度就会很慢。</p>

<h3 id="toc_3">df命令工作原理</h3>

<p>df，disk free，通过文件系统来快速获取空间大小的信息，它的数据是基于分区元数据的，所以只能针对整个分区。由于df直接读取超级块，所以运行速度不受文件多少影响。<br/>
当我们删除一个文件的时候，这个文件不是马上就在文件系统当中消失了，而是暂时消失了，当所有程序都不用时，才会根据OS的规则释放掉已经删除的文件， df记录的是通过文件系统获取到的文件的大小，他比du强的地方就是能够看到已经删除的文件，而且计算大小的时候，把这一部分的空间也加上了，更精确了。</p>

<h2 id="toc_4">怎么办？</h2>

<p>了解了<code>du</code>和<code>df</code>命令的工作原理，再结合之前释放空间时的操作，原因就找到了：执行表删除操作的时候，仍然有进程在使用对应的文件。</p>

<h3 id="toc_5">找到仍在使用已删除文件的进程</h3>

<p>执行<code>lsof | grep deleted</code>命令，查找相应的进程，结果如图1-3所示（这里只截取一部分）：<br/>
<center><br/>
<img src="media/15406290433586/15406338009854.jpg" alt=""/><br/>
图1-3<br/>
</center></p>

<p>在对应列表中，找到被自己删除的文件，kill 掉相应进程就可以了。</p>

<h3 id="toc_6">结果验证</h3>

<p>再次执行 <code>df -h</code> 命令，可以看到如图 1-4所示的结果：<br/>
<center><br/>
<img src="media/15406290433586/15406339199045.jpg" alt=""/><br/>
图1-4<br/>
</center></p>

<p>至此，被偷走的磁盘空间就回来了。撒花~~</p>

<h2 id="toc_7">知识点扩展</h2>

<h3 id="toc_8">尽量避免df和dh出现差距</h3>

<p>工作中，可以通过以下方法避免因为文件删除导致磁盘空间不能正常释放的问题：</p>

<ul>
<li>以清空文件的方式代替删除文件</li>
<li>对于经常发生删除问题的文件，以改名、清空、删除的顺序操作</li>
<li>有些命令也会间接执行删除文件操作，在执行此类命令的时候，为了避免删除问题，建议先确认有没有进程打开相应文件</li>
</ul>

<h3 id="toc_9">不是所有时候都可以直接 kill</h3>

<p>kill进程虽然简单，但也是特别粗暴的方式，执行该操作前，应该确认确定不会对运行中的进程造成影响时使用。有些应用程序对这种方式支持的并不好，当一个正在使用的文件被截断可能会引发不可预知的问题。<br/>
如果觉得直接 kill 进程比较麻烦或者不可操作，可以尝试以下操作：</p>

<ul>
<li>停掉使用这个文件的应用，让 os 自动回收磁盘空间</li>
<li>unmount一下文件系统</li>
<li>重启系统</li>
</ul>

<h3 id="toc_10">lsof 命令</h3>

<p>lsof 全名 list opened files，即列举系统中已经被打开的文件。</p>

<p>lsof 命令通常的输出格式为：</p>

<table>
<thead>
<tr>
<th>COMMAND</th>
<th>PID</th>
<th>USER</th>
<th>FD</th>
<th>TYPE</th>
<th>DEVICE</th>
<th>SIZE</th>
<th>NODE</th>
<th>NAME</th>
</tr>
</thead>

<tbody>
<tr>
<td>默认以9个字符长度显示的命令名称。可使用+c参数指定显示的宽度，若+c后跟的参数为零，则显示命令的全名</td>
<td>进程ID号</td>
<td>命令的执行UID或系统中登陆的用户名称。默认显示为用户名，当使用-l参数时，可显示UID。</td>
<td>文件的File Descriptor number</td>
<td>文件类型</td>
<td>使用character special、block special表示的设备号</td>
<td>文件的大小</td>
<td>本地文件的node码</td>
<td>挂载点和文件的全路径（链接会被解析为实际路径），或者连接双方的地址和端口、状态等</td>
</tr>
</tbody>
</table>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2018/10/27</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='%E6%95%B0%E6%8D%AE%E5%BA%93.html'>数据库</a></span>
          				   
                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15377924479103.html">
                
                  <h1>记一次攒机经历</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>攒机这一念头还是在我的小黑（ThinkPad E430）挂掉之后产生的，毕竟小黑也是陪了我 5 年之久，也是时候换掉了。至于为什么是攒机，一来整机买很难兼顾到各个硬件的性能；二来身为软件专业毕业生，如果没有攒过机，总觉得对不起自己的专业；三是个人认为很多事情总是需要一个人去面对的，鼓起勇气去做，即使失败了，毕竟努力过。于是，长达半年之久的攒机长跑在今年6月16号开始。</p>

<h2 id="toc_0">攒机方案的确定</h2>

<p>讲真，制定第一版攒机方案的时候，甚至不知道应该买哪些硬件，担心买回家硬件之间不能兼容，后来还是在网上找了模拟攒机，凭着自己对主板、CPU、显卡等硬件微不足道的了解，外加各种百度谷歌，以预算8000为标准，确定了第一版攒机方案。找大佬咨询建议，感觉整个方案都要被推翻，主要是对品牌不了解，可能选择了名号响亮但性价比并不高的零件，或者预算太低，选择的性能很是一般般。最纠结的还是显卡和内存，当时显卡选择的是1060，很多人看到方案后都会问“为什么不直接上1080”，主要没钱啊！！内存条最初选择单条8G，其实更倾向于单条16G，仍然是没钱啊（哭晕在厕所）TAT ~~</p>

<p>在犹豫要不要提升预算，升级配置的时候，完美地错过了618大促，随后各个零件价格回升，更是不想买了。于是攒机的事情一再拖延，直到7月份搬家，预交了3个月的房租，手头更是紧张，缓和了两个月后，攒机事项再次提上议程，8月下旬开始频繁关注各个零件的价格，有时间也会和周围的大佬交流心得，最终在9月中旬确定攒机方案！！既然都已经决定自己攒机了，就做得更好一点，尽量把配置一步做到位，也免了随后升级的麻烦。于是显卡确定下来1070，内存条使用单条16G，主板使用技嘉Z370，其他的差不多就可以了。</p>

<h2 id="toc_1">零件购买</h2>

<p>购买零件也是非常糟心的过程。因为想要提前开始组装，于是周三就在京东下单。本来以后即便周四到货，也可以直接放进丰巢，谁知第二天接到快递员电话，说放进丰巢需要我提供收货码，这么贵重的东西我怎么能随便确认收货呢，于是一个生气便拒收了。。。。更可气的是找京东客服问什么情况，假如确认收货了，快递员没有把东西放进丰巢怎么办？谁知京东客服竟然回答概不负责，客户自己和快递小哥商议，简直要吐出一口老血。。。。<br/>
于是接受教训，第二次买直接使用京准达，指定下午6点到8点之间送货。结果快递小哥6点多一点就送到家了，我还在回家的路上，emmmm，也是无语。。。。</p>

<h2 id="toc_2">硬件安装</h2>

<p>一番折腾后，终于把该买的零件都买全了，准备开始硬件安装。拆掉主板包装，看到板子上密密麻麻各种接口，满脑子都是“什么鬼？”、“什么东西？”、“这东西怎么玩?”之类的想法，看到跟教科书一样厚的使用说明书时更是各种崩溃。。。一瞬间，有种硬件在手却不知所措的感觉，甚至有点后悔选择自己攒机。</p>

<p>好在我不是一个轻易被打败的人，～(￣▽￣～)(～￣▽￣)～，买机箱时看到一个公众号提供了攒机视频，于是视频看了好几遍，确定好攒机顺序，然后找各个硬件的客服要教程各种钻研，在脑海中反复确认每一步要做什么（毕竟每个零件都价值不菲，装错了哪一个我都烧不起呀，TAT），最后主板说明书阅读了几遍，每个接口是干什么的，应该怎么安装都搞清楚，心里大概有7、8分谱的时候，开始动手安装硬件。</p>

<p>之前的确认用了大量的时间，真正的硬件安装反而没有用太长时间。很快就来到了布线的环节，主要是把电源上的各种线连接到各个零件上，给各零件供电使用。看着电源上那么多的线，简直就是一脸懵逼，之前教程也没看到过呀，这电源线上也没写哪根线应该连接哪个零件啊，各种不明白，各种无从下手，最终乖乖去研究主板使用说明书了。</p>

<p>说明书的认真阅读，外加我聪明大胆的推测，最终把各种线都连接好。其实电源上的接口都是有一定的规格，只要把对应规格的线连接在相应的零件上就可以了。比如整个主板电源插座，可能主板是24 PIN 供电插座，电源线就需要 20 PIN + 4 PIN 两条线拼接（这种由不通电源来决定），而方向也可以根据无作用针脚位置来确定，这些在主板使用说明书中都可以找到，某些不确定方向的，其实可以看针脚的形状，一般相邻针脚形状是不一样的，由此可以判断插座插入方向。再比如主板跳线插座，主板给提供的插座都是很齐全的，什么重启、电源指示、开关、喇叭阵脚、硬盘动作指示灯等插座都会有，但是否有相应的连接条线也是根据机箱不同而设定的，另外开关和重启键并不需要区分正负极，有的机箱设计就很奇葩（比如开关线两条子线是区分颜色的，重启线两条子线不区分颜色，这就很坑了）。总之，主板、CPU、独立显卡、硬盘、SSD都要供电，只要插入相应插座就可以了。</p>

<h2 id="toc_3">开机测试与系统安装</h2>

<p>接下来要做开机测试，目标是能够成功看到开机 logo 画面，只可惜按下开机键后显示屏一点没有反应，屏幕提示计算机未输出任何信号，在排除了线的故障以及插头松动的可能性后，看到主板除错灯提示AE，查说明书：boot to legacy os。这看起来像是正常的，不就是搜索系统引导嘛，可为什么显示器没有反应啊。。。然后就各种谷歌百度，把主板上所有插座线都依次重插一下，仍然没有解决问题。</p>

<p>最后无奈，微信找了大佬请教，一番描述后，发现竟是我连接线的插座插错了！！主板上是有集显插座的，如果使用了独立显卡，就需要把显示器连接线插进独立显卡的对应插座上，然而我插在了主板上，也是为自己的智商捉急啊。</p>

<p>系统是找公司 IT 帮忙做的（个人比较懒，也不想污染 Mac 去做系统~~），系统安装就比较容易了，选择好系统安装的磁盘位置（高端、大气、上档次的SSD）之后，没一会儿就安装完成了。</p>

<p>重启开机进入系统，将显卡和主板附带的驱动都安装好基本就差不多了。因为还有一块全新的硬盘没有初始化，因此系统还是别不到该磁盘，只能显示系统所在的SSD，管理员身份选择磁盘管理，对新的硬盘做初始化，然后分区。</p>

<h2 id="toc_4">总结</h2>

<p>酱紫，个人的第一次攒机经历到这里就结束了，回顾下来，当时觉得很难，无从下手。真正一点点做下去，直到完成的时候，觉得也还好，也没有遇到一直解决不了的情况。本次攒机，让我对各种硬件知识有了一定的了解，接下来就是开心地玩耍时间啦。完结撒花！！</p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2018/9/24</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='%E9%9A%8F%E6%83%B3.html'>随想</a></span>
          				   
                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15376924661136.html">
                
                  <h1>SQL查询语句之坑</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<h2 id="toc_0">sqlalchemy 相关</h2>

<h3 id="toc_1">查询具体条数count(*)</h3>

<h4 id="toc_2">造成慢查询的语句</h4>

<pre><code class="language-python">count = accountModel.query.filter(accountModel.age&gt;10).count()
</code></pre>

<p>sqlalchemy 会将上述代码拼接成如下所示 SQL 语句</p>

<pre><code class="language-SQL">select count(*) from(select * from account where age&gt;10)
</code></pre>

<h4 id="toc_3">正确的写法</h4>

<pre><code class="language-python">from sqlalchemy import func
count = db.session.query(db.func.count(accountModel.Id)).filter(accountModel.age&gt;10).first()[0]
</code></pre>

<p>sqlalchemy 会将上述代码拼接成如下所示 SQL 语句</p>

<pre><code class="language-SQL">select count(*) from account where age &gt; 10
</code></pre>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2018/9/23</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='%E6%95%B0%E6%8D%AE%E5%BA%93.html'>数据库</a></span>
          				   
                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
              


			<div class="row">
			  <div class="large-6 columns">
			  <p class="text-left" style="padding-top:25px;">
			   
			  </p>
			  </div>
			  <div class="large-6 columns">
			<p class="text-right" style="padding-top:25px;">
			 <a href="all_1.html">&raquo; Next Page</a> 
			</p>
			  </div>
			</div>
		</div>
	</div><!-- large 8 -->

 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <div class="site-a-logo"><img src="http://cdn.blog.yanzl.net/2018-11-03-%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-11-03%20%E4%B8%8B%E5%8D%8811.05.15.png" /></div>
            
                <h1>零度燕窝</h1>
                <div class="site-des"></div>
                <div class="social">









<a target="_blank" class="github" target="_blank" href="https://github.com/CodeBall" title="GitHub">GitHub</a>

  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="%E6%95%B0%E6%8D%AE%E5%BA%93.html"><strong>数据库</strong></a>
        
            <a href="Python.html"><strong>Python</strong></a>
        
            <a href="%E9%9A%8F%E6%83%B3.html"><strong>随想</strong></a>
        
            <a href="%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84&%E7%AE%97%E6%B3%95.html"><strong>数据结构&算法</strong></a>
        
            <a href="Fluent%20Python.html"><strong>Fluent Python</strong></a>
        
            <a href="%E8%AF%BB%E4%B9%A6%E9%9A%8F%E7%AC%94.html"><strong>读书随笔</strong></a>
        
            <a href="%E6%9B%BE%E7%BB%8F%E6%9D%A5%E8%BF%87.html"><strong>曾经来过</strong></a>
        
            <a href="PHP.html"><strong>PHP</strong></a>
        
            <a href="Ubuntu.html"><strong>Ubuntu</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="15463298937289.html">人生第一次30公里复盘总结</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15421053722232.html">Flask 流式相应实现文件下载及常见问题总结</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15406290433586.html">扎心！有人偷走了我的磁盘空间？！</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15377924479103.html">记一次攒机经历</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15376924661136.html">SQL查询语句之坑</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>

    <script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>


  </body>
</html>
